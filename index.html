<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title></title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="" />
    <style type="text/css" media="screen">

body{
    display: grid;
    background-color:grey;
}

.controls{
    display:grid;
    justify-self:center;
    width:15vw;
    height:50vw;
    margin-top: 20vh;
    border-radius: .5vw;
    background-color:#d3d3d3;
}

.button-container{
    display:grid;
    width:95%;
    height:40%;
    border-radius: .5vw;
    justify-self: center;
    align-self: start;
    margin-top: 10vw;
    grid-template-columns: repeat(4,1fr);
    grid-template-rows: 20% 10% 30% 10% 5%;
    grid-template-areas: 
        "top top top top"
        "  .  .  .  .  "
        "mid mid mid mid"
        "mid mid mid mid"
        "  .  .  .  .  "
        "spc spc spc spc";
    background-color: #787878;
}

.utility-container{
    display:grid;
    grid-template-columns:repeat(4,1fr);
    grid-area: top;
}

.middle-container{
    display:grid;
    grid-template-columns:repeat(4,1fr);
    grid-template-rows: repeat(2,1fr);
    grid-area: mid;
}

.space-container{
    display:grid;
    grid-area: spc;
}

.middle.button,.utility.button,.audio-context.button{
    margin-top: -.5vw;
    --button-size: 2.8vw;
/*  
    To Center a absolute
    (length of container - width of button) / 2)*100 / length of container
*/
    margin-left:10.8%; 
}

.button-top {
    background-color: #0083bb;
    z-index: 10;
}

.button-top, .button-bottom{
    position: absolute;
    width:var(--button-size);
    height:var(--button-size);
    border-radius: .5vw;
}

.button-bottom{
    background-color:black;
    margin-top: 1.5vw;
}

.space-bar{
/*  
    To Center a absolute
    (length of container - width of button) / 2)*100 / length of container
*/
}

.space-top{
    background-color: #0083bb;
    z-index: 10;
}

.space.button-top,.space.button-bottom{
    width: 13.6vw;
    height: 2.8vw;
    margin-left:.35vw;
    position: absolute;
    border-radius: .5vw;
}

.space-bottom{
    background-color:black;
    margin-top:1.5vw;
}

    </style>

  </head>
      <body>

          <div class="audio-context button">
              <div class="audio-context button-top"></div>
              <div class="audio-context button-bottom"></div>
          </div>

          <div class="controls">
              <div class="button-container">
                  <div class="utility-container">
                      <div class="utility button">
                          <div class="utility button-top"></div>
                          <div class="utility button-bottom"></div>
                      </div>
                      <div class="utility button">
                          <div class="utility button-top"></div>
                          <div class="utility button-bottom"></div>
                      </div>
                      <div class="utility button">
                          <div class="utility button-top"></div>
                          <div class="utility button-bottom"></div>
                      </div>
                      <div class="utility button">
                          <div class="utility button-top"></div>
                          <div class="utility button-bottom"></div>
                      </div>
                  </div>
                  <div class="middle-container">
                      <div class="middle button">
                          <div class="button-top"></div>
                          <div class="button-bottom"></div>
                      </div>
                      <div class="middle button">
                          <div class="button-top"></div>
                          <div class="button-bottom"></div>
                      </div>
                      <div class="middle button">
                          <div class="button-top"></div>
                          <div class="button-bottom"></div>
                      </div>
                      <div class="middle button">
                          <div class="button-top"></div>
                          <div class="button-bottom"></div>
                      </div>
                      <div class="middle button">
                          <div class="button-top"></div>
                          <div class="button-bottom"></div>
                      </div>
                      <div class="middle button">
                          <div class="button-top"></div>
                          <div class="button-bottom"></div>
                      </div>
                      <div class="middle button">
                          <div class="button-top"></div>
                          <div class="button-bottom"></div>
                      </div>
                      <div class="middle button">
                          <div class="button-top"></div>
                          <div class="button-bottom"></div>
                      </div>
                  </div>
                  <div class="space-container button">
                      <div class="space button-top"></div>
                      <div class="space button-bottom"></div>
                  </div>
                  </div>
              </div>
            </div>
      </body>

    <script src="Dependencies/Tone.js" defer></script>
    <script>


///////////////////STATE/////////////////////////////////////////////
    const buttonState = {};
    const utility = {
        toggleSomething: toggleSomething,
        changeButtonColor: changeButtonColor,
    }
    const audio = {
        player: null,
        playSample:playSample,
    }
    const properties = {
        playheadColor:"red",
        originalColor:"#0083bb",
        triggerColor:"#00908a",
    };

    function initButtonState(){
        for(let i = 0; i < 8; i++){
            buttonState[i] = {trigger : 0, playhead: 0};
        }
   }

    initButtonState();

    async function startAudioContext(){

        await Tone.start();   
        Tone.Transport.start();
        function initSamples(){
            const player = new Tone.Player("./Samples/Jank_Drums/actual_kik.wav").toDestination();
            audio.player = player;
        }
        initSamples();

    }

///////////////////STATE/////////////////////////////////////////////

///////////////////METHODS///////////////////////////////////////////
    function toggleSomething(tally){
        tally += 1;
        return tally % 2 
    }

    function changeButtonColor(buttonElement,buttonIndex,color){
            buttonIndex = buttonIndex - 5;
// If there are two colors given for arguments, the function will toggle between them
// based on that button's status in the buttonState object
            if(color === "toggle"){
                buttonState[buttonIndex].trigger = 
                    toggleSomething(buttonState[buttonIndex].trigger);
                const colorAlternate = arguments[3];
                const colorOriginal = arguments[4];
                color = buttonState[buttonIndex].trigger? colorOriginal : colorAlternate; 
                console.log("buttonState: ",buttonState);
            }            

            buttonTopChange = buttonElement.getElementsByClassName("button-top")[0];
            buttonTopChange.style.backgroundColor = color;

    }

    function playSample(time){
        audio.player.start(time);
    }
///////////////////METHODS///////////////////////////////////////////

    function startLoop(){
        const {toggleSomething,changeButtonColor} = utility;
        let loopLength = 8;
        let playheadIndex = 0;
        let eraserIndex = loopLength - 1;
        const {playheadColor,originalColor,triggerColor} = properties;
        const buttonElement =
                document.getElementsByClassName("middle button");

        function advanceSteps(){
            const loop = new Tone.Loop((time) => {

                function updateButtonState(){
                    buttonState[playheadIndex].playhead = 
                    toggleSomething(buttonState[playheadIndex].playhead);


                    if(buttonState[eraserIndex].playhead){
                        buttonState[eraserIndex].playhead = 
                        toggleSomething(buttonState[eraserIndex].playhead);
                    }
                }
                updateButtonState();

                function drawPlayhead(){
                    const eraseButton = 
                        buttonElement[eraserIndex];
                    const playheadButton = 
                        buttonElement[playheadIndex];

                    if(buttonState[playheadIndex].trigger){
                        changeButtonColor(eraseButton,triggerColor);
                    }
                    // If the current step has a trigger on it, change color to trigger color
                    const returnToColor = buttonState[eraserIndex].trigger ? 
                        triggerColor : originalColor;

                    changeButtonColor(eraseButton,eraserIndex,returnToColor);


                    changeButtonColor(playheadButton,playheadIndex,playheadColor);

                detectTriggerActivation();

                    playheadIndex += 1;
                    eraserIndex += 1;

                    if(playheadIndex === loopLength){
                        playheadIndex = 0;
                        eraserIndex = loopLength - 1;
                    }else if(eraserIndex === loopLength){
                        eraserIndex = 0;
                    }
                }
                drawPlayhead();

                function detectTriggerActivation(){
                    console.log("START trigger activation")
                    console.log("playheadIndex",playheadIndex);
                    console.log("trigger",buttonState[playheadIndex].trigger);
                    console.log("playhead",buttonState[playheadIndex].playhead);
                    if(buttonState[playheadIndex].trigger 
                        && buttonState[playheadIndex].playhead){
                    console.log("trigger activation!");
                    audio.playSample(time);             
                    }
                    console.log("END trigger activation")
                }

            },"8n").start(0);
        }
        advanceSteps();
    }


    function addButtonControlToTrigger(){
    
        let buttonList = document.getElementsByClassName("button");
        let audioContextKeyList = "q";
        let utilityKeyList = "7890";
        let middleKeyList = "uiopjkl;";
        let functionKeyList = " ";
        let keyList =
            [...audioContextKeyList,...utilityKeyList,...middleKeyList,...functionKeyList];
        let buttonTopMoving = {};

        function keyIndex(key){ 
            return keyList.indexOf(key);
        };

        function moveButton(buttonElement,distance){
            buttonTopMoving = buttonElement.getElementsByClassName("button-top")[0];
            buttonTopMoving.style.marginTop = distance;
        }

        
        document.addEventListener("keydown",(event) => {

            if(keyIndex(event.key) < 0) return; 
            event.preventDefault();
            let buttonIndex = keyIndex(event.key);
            let buttonElement = buttonList[buttonIndex];
            moveButton(buttonElement,".8vw");
            startAudioContext();
            if(event.key === "q"){

              startLoop();

            }

            if(middleKeyList.indexOf(event.key) > -1) changeButtonColor(buttonElement,buttonIndex,"toggle","#0083bb","#00908a"); 

        });

        document.addEventListener("keyup",(event) => {

            if(keyIndex(event.key) < 0) return;
            moveButton(buttonList[keyIndex(event.key)],"0vw");

        });

        buttonList[0].addEventListener("load",whenButtonsLoad());

        function whenButtonsLoad(){

            for(const buttonIndex in buttonList){
                buttonList[buttonIndex].addEventListener("mousedown",event => {
                        moveButton(event.currentTarget,".8vw");
                    });

                buttonList[buttonIndex].addEventListener("mouseup",event => {
                        moveButton(event.currentTarget,"0vw");
                    });
        
            }
        };

    }
    addButtonControlToTrigger();

    </script defer async>
    <!--
    <script class="consolidate" src="Consolidate/main.js" defer=""></script>
     -->
</html>
